---
title: "Atgnat from SingleCellExperiment"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{from-sce}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(atgnat)
library(SingleCellExperiment, quietly=TRUE)
library(tradeSeq, quietly=TRUE)
library(slingshot, quietly=TRUE)
library(scran, quietly=TRUE)
library(scater, quietly=TRUE)
RNGversion("3.5.0")
set.seed(7)
```

## Setting up the Single Cell Experiment

First, let's generate a Single Cell Experiment to use the tool with, based on the tradeSeq vignette [<https://bioconductor.org/packages/devel/bioc/vignettes/tradeSeq/inst/doc/tradeSeq.html>]. We need to have the following to use Atgnat:

-   A Single Cell Experiment with pseudotime.

-   A list of genes generated by `fitGAM` and `associationTest`

```{r}
data(countMatrix, package = "tradeSeq")
counts <- as.matrix(countMatrix)
rm(countMatrix)
data(crv, package = "tradeSeq")
data(celltype, package = "tradeSeq")

pseudotime <- slingPseudotime(crv, na = FALSE)
cellWeights <- slingCurveWeights(crv)
sce <- fitGAM(counts = counts, pseudotime = pseudotime, cellWeights = cellWeights,
                 nknots = 6, verbose = FALSE)

sce$pseudotime = pseudotime[,"curve1"]
sce$celltype = celltype
sce <- computeSumFactors(sce, clusters=quickCluster(sce))
sce <- logNormCounts(sce)
normcounts(sce) <- exp(logcounts(sce))
sce = runUMAP(sce)

gridExtra::grid.arrange(
      plotUMAP(sce, text_by="celltype", colour_by="celltype"),
      plotUMAP(sce, colour_by="pseudotime"),
      ncol=1
    )
```

## Finding the most descriptive genes with tradeSeq
Now we'll find the genes we want to use. We select the top 100 so that we can do some parameter tuning below.

```{r}
# Use consecutive for genes that change over time
assoRes = associationTest(sce, lineages=T, global=F, contrastType="consecutive")
genelist = atgnat::get_top_n_genes(assoRes, n_genes = 100, lineage = 1)
```

## Parameter Tuning for Atgnat
And see what parameters are best for Atgnat:
```{r}
res = atgnat::find_best_params(sce, genelist, split_by="pseudotime_range", pseudotime_slot="pseudotime")
atgnat::plot_find_best_params_results(res)
```

It looks like 80 genes and 10 bins will give us good specificity, but let's double check. In a non trivial dataset, this may take some repetition. We ignore the 5 bin result because this might not be enough resolution - this depends on your dataset. In general, more bins will reduce specificity because each bin will have a more similar cell composition. In general, aim for about as many bins as you have clusters.

### Inspect Bin Choice

```{r}
atgnat_data = as.AtgnatData(sce, pseudotime_slot="pseudotime", n_bins=10)
atgnat_data@genes = genelist[1:80]
evaluate_parameters(atgnat_data, make_plot = TRUE)
```
### Inspect Genes Choice

```{r}
evaluate_top_n_genes(atgnat_data)
```

## Mapping Bulk Samples to SC with Atgnat

If we're happy, now we can try to map a bulk sample onto the single cell. We'll do this by cell types in the SingleCellExperiment but in reality you should use a real bulk dataset.

```{r}
bulks_df = DataFrame(row.names = rownames(counts(sce)))
for (type in unique(sce$celltype)) {
  bulks_df = cbind(bulks_df, rowSums(normcounts(subset(sce, , celltype==type))))
}
colnames(bulks_df) = unique(sce$celltype)

erythrocyte_result = map_best_bin(atgnat_data, "Erythrocyte", bulks_df)
erythrocyte_result
GMP_result = map_best_bin(atgnat_data, "GMP", bulks_df)
GMP_result
neutrophils_result = map_best_bin(atgnat_data, "Neutrophils", bulks_df)
neutrophils_result
```
### Plotting Heatmap of Mappings

To see how well we plotted the differences between these cell types, we can plot a heatmap of all these results. We can see that many of the results are significantly correlated - this makes sense, as these cell types exist on a trajectory between each other!

```{r}
plot_mapping_result_heatmap(list(
  erythrocyte_result, 
  GMP_result, 
  neutrophils_result), pvalue_cutoff = 0.01)
```

### Plotting Detailed Plots of Mappings

Now we can do some more detailed plotting about where the bins mapped onto the Single Cell data, and the cell type proportions we expect , but we need to add the pseudotime bins to the metadata of the SCE:

```{r}
binned_sce = assign_pseudotime_bins(sce, split_by="pseudotime_range", n_bins=10, pseudotime_slot="pseudotime")

plot_mapping_result(binned_sce, erythrocyte_result, group_by_slot="celltype")
plot_mapping_result(binned_sce, GMP_result, group_by_slot="celltype")
plot_mapping_result(binned_sce, neutrophils_result, group_by_slot="celltype")

```
