---
title: "Generating Simulated Data Test dataset"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generating Simulated Data Test dataset}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, eval=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Generating Simulated Dataset

This article, which is not run for this website, shows how we simulated the dataset used in the simulated data article.

```{r, setup, eval=FALSE}
library(blase)
library(SingleCellExperiment)
library(tradeSeq)
library(slingshot)
library(scran)
library(scater)
library(BiocParallel)
library(dyngen)
library(bluster)
library(fs)
library(utils)
```

First configure R:
```{r randomseed, eval=FALSE}
RNGversion("3.5.0")
SEED = 7
set.seed(SEED)
```

```{r, concurrency, eval=FALSE}
N_CORES = 4
if (ami::using_ci()) {
  N_CORES = 2
}
```

## Generate the simulation data
Based on the [dyngen Getting Started tutorial](https://dyngen.dynverse.org/articles/getting_started.html#step-1-define-backbone-and-other-parameters). 
```{r generateCounts, eval=FALSE}
# realnet for featurenetwork from realnets
# realcount for generate experiment from realcounts

simulations_num = 150
backbone <- backbone_linear_simple()
config <-
  initialise_model(
    backbone = backbone,
    num_cells = 2000,
    num_tfs = nrow(backbone$module_info),
    num_targets = 400,
    num_hks = 50,
    verbose = FALSE,
    feature_network_params = feature_network_default(
      realnet="regulatorycircuits_04_mesenchymal_mixed"
    ),
    experiment_params = experiment_snapshot(
      realcount="zenodo_1443566_real_silver_trophoblast-stem-cell-trophoblast-differentiation_mca"
    ),
    download_cache_dir = tools::R_user_dir("dyngen", "data"),
    simulation_params = simulation_default(
      total_time = 1000,
      ssa_algorithm = ssa_etl(tau = 30/3600),
      census_interval = 4,
      experiment_params = simulation_type_wild_type(num_simulations = simulations_num, seed=seq_len(simulations_num))
    ),
    num_cores=N_CORES
  )

# Should be > 10 ideally
floor(config$simulation_params$total_time / config$simulation_params$census_interval) * simulations_num / config$numbers$num_cells
config$experiment_params$realcount
config$feature_network_params$realnet

model <- generate_tf_network(config)
model <- generate_feature_network(model)
model <- generate_kinetics(model)
model <- generate_gold_standard(model)
model <- generate_cells(model)
model <- generate_experiment(model)
```


```{r, eval=FALSE}
#model = readRDS("/Users/andrewmccluskey/Library/Application Support/org.R-project.R/R/BLASE/compare_simulated_data/simulation.rds")
```

Now we'll create an SCE out of the simulation
```{r, eval=FALSE}
sce <- as_sce(model)

sce <- computeSumFactors(sce)
sce <- logNormCounts(sce)
normcounts(sce) <- exp(logcounts(sce))
sce = runPCA(sce)
sce = runUMAP(sce)
colLabels(sce) <- clusterCells(sce, use.dimred='PCA',
    BLUSPARAM=NNGraphParam(cluster.fun="louvain")) 
```

## Saving the SCE Object
Now we save the RDS so we can distribute with BLASE.
```{r, saveRDS, eval=FALSE}
processed_simulated_data_SCE = sce
usethis::use_data(processed_simulated_data_SCE, overwrite = TRUE, compress = "bzip2")
```

## Loading the SCE Object
You can load this SCE with:
```{r, loadRDS}
data(processed_simulated_data_SCE, package="blase")
processed_simulated_data_SCE
```

## Session Info
``` {r}
sessionInfo()
```
