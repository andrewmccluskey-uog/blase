---
title: "BLASE for Hematopoesis"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(blase)
library(fs)
library(Seurat)
library(dplyr)
library(slingshot)
library(tradeSeq)
library(BiocParallel)
library(scran)
library(scater)
library(viridis)
```

First configure R:
```{r, randomseed}
RNGversion("3.5.0")
SEED = 7
set.seed(SEED)
```

```{r, concurrency}
N_CORES = 4
if (ami::using_ci()) {
  N_CORES = 2
}
```

## Load Single Cell
```{r}
data(processed_weng_2024_haematopoiesis, package="blase")
processed_weng_2024_haematopoiesis

plotUMAP(processed_weng_2024_haematopoiesis, color_by="STD.CellType")
plotUMAP(processed_weng_2024_haematopoiesis, color_by="slingPseudotime_1")
```


```{r}
expected_trajectory = c(
    'Refined.HSC',
    'HSC', # Haematopoeitic Stem Cell
    'MPP', # multipotent progenitors
    'CMP', # common myeloid progenitor
    'GMP', # granulocyteâ€“monocyte progenitors
    'MDP', # Monocyte-dendritic cell progenitor
    'Mono' # Monocytes
)

start_cell_type = expected_trajectory[1]
end_cell_type = expected_trajectory[length(expected_trajectory)]
```



```{r}
associationTestResult <- associationTest(processed_weng_2024_haematopoiesis, lineages=T, global=F, contrastType="consecutive")
head(associationTestResult)
nrow(associationTestResult)
```
## Set up BLASE
```{r}
genelist = blase::get_top_n_genes(associationTestResult, n_genes = 1000, lineage = 1)
res = blase::find_best_params(processed_weng_2024_haematopoiesis, genelist, split_by="pseudotime_range", bins_count_range=c(6, 7, 8,9, 10),gene_count_range=c(10,20,40, 60, 80, 100, 120, 160, 240, 480, 960))

blase::plot_find_best_params_results(res)
```

```{r}
blase_data = as.BlaseData(processed_weng_2024_haematopoiesis, n_bins=9)
blase_data@genes = genelist[1:480]
evaluate_parameters(blase_data, make_plot = TRUE)
```

## Generate "bulk" datasets
In this article we will pseudobulk the Single Cell data into bulk datasets to demonstrate that
BLASE can map a given cluster back to itself.
```{r}
bulks_df = DataFrame(row.names = rownames(counts(processed_weng_2024_haematopoiesis)))
for (type in unique(processed_weng_2024_haematopoiesis$STD.CellType)) {
  bulks_df = cbind(bulks_df, rowSums(normcounts(subset(processed_weng_2024_haematopoiesis, , STD.CellType==type))))
}
colnames(bulks_df) = as.character(unique(processed_weng_2024_haematopoiesis$STD.CellType))
```

## Run BLASE
We will now verify that BLASE can accurately map these "bulk" datasets back to the SC clusters

```{r}
results = c()
for (type in expected_trajectory) {
  print(type)
  results = c(results, map_best_bin(blase_data, type, bulks_df))
}
```

```{r}
results
plot_mapping_result_heatmap(as.list(results))
```
```{r}
sessionInfo()
```