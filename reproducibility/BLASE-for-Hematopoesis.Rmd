---
title: "BLASE for Hematopoesis"
author: Andrew McCluskey
date: 20/6/2024
output: rmarkdown::html_vignette
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(blase)
library(fs)
library(Seurat)
library(dplyr)
library(slingshot)
library(tradeSeq)
library(BiocParallel)
library(scran)
library(scater)
library(viridis)
library(gridExtra)
```

First configure R:
```{r, randomseed}
RNGversion("3.5.0")
SEED <- 7
set.seed(SEED)
```

```{r, concurrency}
# N_CORES = 4
if (ami::using_ci()) {
  N_CORES <- 2
}
```

## Load Single Cell
```{r}
data(processed_weng_2024_haematopoiesis, package = "blase")
processed_weng_2024_haematopoiesis

gridExtra::grid.arrange(
  plotUMAP(processed_weng_2024_haematopoiesis, color_by = "STD.CellType", text_by = "STD.CellType"),
  plotUMAP(processed_weng_2024_haematopoiesis, color_by = "slingPseudotime_1"),
  ncol = 1
)
```


```{r}
expected_trajectory = c(
  'Refined.HSC',
  'HSC', # Haematopoeitic Stem Cell
  'MPP', # multipotent progenitors
  'CMP', # common myeloid progenitor
  'GMP', # granulocyteâ€“monocyte progenitors
  'MDP' # Monocyte-dendritic cell progenitor
  # 'Mono' # Monocytes - excluded as unclear if part of true haematopoiesis process or mature and BM resident
)

start_cell_type <- expected_trajectory[1]
end_cell_type <- expected_trajectory[length(expected_trajectory)]
```



```{r}
associationTestResult <- associationTest(processed_weng_2024_haematopoiesis, lineages = T, global = F, contrastType = "consecutive")
head(associationTestResult)
nrow(associationTestResult)
```
## Set up BLASE
```{r}
genelist <- blase::get_top_n_genes(associationTestResult, n_genes = 1000, lineage = 1)
res <- blase::find_best_params(processed_weng_2024_haematopoiesis, genelist, split_by = "pseudotime_range", bins_count_range = c(4, 5, 6, 7, 8, 9, 10), gene_count_range = c(10, 20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360))

blase::plot_find_best_params_results(res)
```

```{r}
blase_data = as.BlaseData(processed_weng_2024_haematopoiesis, n_bins = 7)
blase_data@genes = genelist[1:160]
evaluate_parameters(blase_data, make_plot = TRUE)
```
You can also inspect how the top genes change over each pseudotime bin:

```{r}
evaluate_top_n_genes(blase_data)
```

## Generate "bulk" datasets
In this article we will pseudobulk the Single Cell data into bulk datasets to demonstrate that
BLASE can map a given cluster back to itself.
```{r}
bulks_df = DataFrame(row.names = rownames(counts(processed_weng_2024_haematopoiesis)))
for (type in unique(processed_weng_2024_haematopoiesis$STD.CellType)) {
  bulks_df = cbind(bulks_df, rowSums(normcounts(subset(processed_weng_2024_haematopoiesis, , STD.CellType == type))))
}
colnames(bulks_df) = as.character(unique(processed_weng_2024_haematopoiesis$STD.CellType))
```

## Run BLASE
We will now verify that BLASE can accurately map these "bulk" datasets back to the SC clusters

```{r}
results = c()
for (type in expected_trajectory) {
  print(type)
  results = c(results, map_best_bin(blase_data, type, bulks_df))
}
```

```{r}
results
plot_mapping_result_heatmap(as.list(results))
```
## Test comparison tools
```{r}
getwd()
source('comparison_functions.R')
```

### SCDC
```{r SCDC}
res <- SCDC(processed_weng_2024_haematopoiesis, 'STD.CellType', bulks_df, 'Sample')
print(res$prop.est.mvw)

to_plot <- as.data.frame(res$prop.est.mvw)
to_plot <- to_plot[, sort(colnames(to_plot))]
to_plot$BulkID <- rownames(to_plot)
to_plot <- melt(to_plot)

ggplot(to_plot, aes(variable, BulkID)) +
  geom_tile(aes(fill = value), colour = "white") +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_gradient(low = "white", high = "red")
```

### MuSiC
```{r music}
resm <- MUSIC(processed_weng_2024_haematopoiesis, 'STD.CellType', bulks_df, 'Sample')
print(resm$prop.est.mvw)

to_plot <- as.data.frame(resm$Est.prop.weighted)
to_plot <- to_plot[, sort(colnames(to_plot))]
to_plot$BulkID <- rownames(to_plot)

print(resm$r.squared.full)
```

### CibersortX

```{r cibersort}
cibersort <- CibersortX(processed_weng_2024_haematopoiesis, 'STD.CellType', bulks_df, N_CORES)
to_plot <- as.data.frame(cibersort)
to_plot <- subset(to_plot, select = -c(P.value, Correlation, RMSE))
to_plot <- to_plot[, sort(colnames(to_plot))]
to_plot$BulkID <- rownames(to_plot)
to_plot <- melt(to_plot)

ggplot(to_plot, aes(variable, BulkID)) +
  geom_tile(aes(fill = value), colour = "white") +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_gradient(low = "white", high = "red")
```

```{r}
sessionInfo()
```